{{- template "common.deployment" (list . "application.deployment") -}}
{{- define "application.deployment" -}}
{{- $fullname := include "common.fullname" . -}}
{{- $config := default (dict) .Values.config -}}
{{- $configData := default (dict) $config.data -}}
{{- $persistence := default (dict) .Values.persistence -}}
{{- $secrets := default (dict) .Values.secrets -}}
{{- $mountAsFiles := default (dict) $secrets.mountAsFiles -}}
{{- $volumePermissions := default (dict) $persistence.volumePermissions -}}
{{- $volumePermissionsEnabled := ternary $volumePermissions.enabled true (hasKey $volumePermissions "enabled") -}}
{{- $volumePermissionsRunAsUser := ternary $volumePermissions.runAsUser 0 (hasKey $volumePermissions "runAsUser") -}}
{{- $healthCheck := default (dict) .Values.healthCheck -}}
spec:
  template:
    spec:
      {{- if .Values.persistence.enabled }}
      securityContext:
        fsGroup: {{ .Values.persistence.fsGroup | default 1000 }}
        runAsUser: {{ .Values.persistence.runAsUser | default 1000 }}
        runAsGroup: {{ .Values.persistence.runAsGroup | default 1000 }}
      {{- if $volumePermissionsEnabled }}
      initContainers:
        - name: volume-permissions
          image: busybox:1.35
          command: ['sh', '-c']
          args:
            - |
              mkdir -p {{ .Values.persistence.mountPath }}/mlruns
              chown -R {{ .Values.persistence.runAsUser | default 1000 }}:{{ .Values.persistence.runAsGroup | default 1000 }} {{ .Values.persistence.mountPath }}
              chmod -R 755 {{ .Values.persistence.mountPath }}
          securityContext:
            runAsUser: {{ $volumePermissionsRunAsUser }}
          volumeMounts:
            - name: mlflow-storage
              mountPath: {{ .Values.persistence.mountPath }}
      {{- end }}
      {{- end }}
      containers:
        - name: app
          ports:
          - name: http
            containerPort: {{ $configData.MLFLOW_PORT | default 8080 }}
            protocol: TCP
          image: "{{ default "ghcr.io/mlflow-oidc" .Values.image.registry }}/{{ .Values.image.name }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ default "IfNotPresent" .Values.image.pullPolicy }}
          {{- if .Values.persistence.enabled }}
          securityContext:
            runAsUser: {{ .Values.persistence.runAsUser | default 1000 }}
            runAsGroup: {{ .Values.persistence.runAsGroup | default 1000 }}
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
          {{- end }}
          command: ["mlflow"]
          args:
            - server
            - --app-name
            - oidc-auth
          {{- if eq $healthCheck.enabled true }}
          {{ include "common.healthcheck.liveness" . | nindent 10 }}
          {{ include "common.healthcheck.readiness" . | nindent 10 }}
          {{ include "common.healthcheck.startup" . | nindent 10 }}
          {{- end }}
          env:
            {{- /* Enable Kubernetes secrets provider when mounting secrets as files */}}
            {{- if $mountAsFiles.enabled }}
            - name: CONFIG_K8S_SECRETS_ENABLED
              value: "true"
            - name: CONFIG_K8S_SECRETS_PATH
              value: {{ $mountAsFiles.path | default "/var/run/secrets/mlflow-oidc-auth" | quote }}
            {{- end }}
          volumeMounts:
            {{- if .Values.persistence.enabled }}
            - name: mlflow-storage
              mountPath: {{ .Values.persistence.mountPath }}
            {{- end }}
            {{- /* Mount secrets as files for K8s secrets provider */}}
            {{- if and $secrets.externalSecretName $mountAsFiles.enabled }}
            - name: mlflow-secrets
              mountPath: {{ $mountAsFiles.path | default "/var/run/secrets/mlflow-oidc-auth" }}
              readOnly: true
            {{- end }}
          envFrom:
            - configMapRef:
                name: {{ template "common.fullname" . }}
            {{- /* Reference external secret as environment variables (when not mounting as files) */}}
            {{- if and $secrets.externalSecretName (not $mountAsFiles.enabled) }}
            - secretRef:
                name: {{ $secrets.externalSecretName }}
            {{- end }}
            {{ include "common.envvar.shared.configs" . | indent 12 }}
            {{ include "common.envvar.shared.secrets" . | indent 12 }}
          {{ include "common.resources" . | nindent 10 }}
      volumes:
        {{- if .Values.persistence.enabled }}
        - name: mlflow-storage
          persistentVolumeClaim:
            claimName: {{ include "common.fullname" . }}-storage
        {{- end }}
        {{- /* Secret volume for K8s secrets provider */}}
        {{- if and $secrets.externalSecretName $mountAsFiles.enabled }}
        - name: mlflow-secrets
          secret:
            secretName: {{ $secrets.externalSecretName }}
        {{- end }}
{{- end -}}
